<html>
<head>
<title>main.cpp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #080808;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main.cpp</font>
</center></td></tr></table>
<pre>
<span class="s0">&lt;!DOCTYPE html&gt;</span>

<span class="s0">&lt;head&gt;</span>
<span class="s0">&lt;meta name=</span><span class="s1">&quot;viewport&quot; </span><span class="s0">content=</span><span class="s1">&quot;width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0&quot;</span><span class="s0">&gt;</span>
                              <span class="s0">&lt;title&gt;AR project </span><span class="s2">template</span><span class="s0">&lt;/title&gt;</span>
<span class="s0">&lt;!-- Додаємо необхідні бібліотеки --&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;js/three.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;js/tween.umd.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">'loaders/GLTFLoader.js'</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">'loaders/GLTF2Loader.js'</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">'loaders/MTLLoader.js'</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">'loaders/OBJLoader.js'</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;!-- Додаємо jsartookit --&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;jsartoolkit5/artoolkit.min.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;jsartoolkit5/artoolkit.api.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;!-- Додаємо threex.artoolkit --&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;threex/threex-artoolkitsource.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;threex/threex-artoolkitcontext.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;threex/threex-arbasecontrols.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;script src=</span><span class="s1">&quot;threex/threex-armarkercontrols.js&quot;</span><span class="s0">&gt;&lt;/script&gt;</span>
<span class="s0">&lt;/head&gt;</span>

<span class="s0">&lt;body style=</span><span class="s1">'margin : 0px; overflow: hidden; font-family: Monospace; user-select: none; pointer-events: none;'</span><span class="s0">&gt;</span>

            <span class="s0">&lt;div id=</span><span class="s1">&quot;access&quot; </span><span class="s0">style=</span><span class="s1">&quot;top: 0; left: 0; right:0; bottom: 0; background: #000; position: absolute; user-select: all; pointer-events: all;&quot;</span><span class="s0">&gt;</span>
                                   <span class="s0">&lt;div id=</span><span class="s1">&quot;text-wrapper&quot; </span><span class="s0">style=</span><span class="s1">&quot;top: 50%; left: 50%; position: absolute; color: #fff; transform: translate(-50%, -50%); text-align: center;</span>
<span class="s0">text-transform: uppercase; font-family: Arial, Helvetica, sans-serif; font-weight: </span><span class="s3">400</span><span class="s0">; line-height: 1.5em; font-size: large; white-space: nowrap;</span>
<span class="s0">user-select: none; pointer-events: none;</span>
<span class="s1">&quot;&gt;</span>
<span class="s0">Press here</span>
        <span class="s0">&lt;br&gt;</span>
<span class="s0">to enter the experience</span>
        <span class="s0">&lt;/div&gt;</span>
<span class="s0">&lt;/div&gt;</span>

<span class="s0">&lt;div id=</span><span class="s1">&quot;loader&quot; </span><span class="s0">style=</span><span class="s1">&quot;position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; pointer-events: none; user-select: none;</span>
<span class="s0">transition: all </span><span class="s3">.2</span><span class="s0">s linear; display: none;</span><span class="s1">&quot;&gt;</span>
<span class="s0">&lt;div style=</span><span class="s1">&quot;left: 50%; top: 50%; position: absolute; transform: translate(-50%, -50%); text-align: center; width: 130px; height: 165px;</span>
<span class="s0">font-family: Arial, Helvetica, sans-serif; font-weight: </span><span class="s3">400</span><span class="s0">; line-height: 1.5em; font-size: large;</span><span class="s1">&quot; class=&quot;</span><span class="s0">spinner-wrapper</span><span class="s1">&quot;&gt;</span>
<span class="s0">&lt;img style=</span><span class="s1">&quot;width: 130px; height: 130px; pointer-events: none; user-select: none;&quot; </span><span class="s0">src=</span><span class="s1">&quot;data/spin.gif&quot; </span><span class="s0">alt=</span><span class="s1">&quot;spin gif&quot;</span><span class="s0">&gt;</span>
                                                                                                           <span class="s0">&lt;br&gt;</span>
                                                                                                           <span class="s0">Loading...</span>
<span class="s0">&lt;/div&gt;</span>
<span class="s0">&lt;/div&gt;</span>

<span class="s0">&lt;script&gt;</span>
<span class="s2">const </span><span class="s0">access = document.getElementById(</span><span class="s1">'access'</span><span class="s0">);</span>
<span class="s2">const </span><span class="s0">loader = document.getElementById(</span><span class="s1">'loader'</span><span class="s0">);</span>

<span class="s0">function initiateExperience() {</span>
    <span class="s4">// Оголошуємо глобальні змінні</span>
    <span class="s0">var scene, camera, renderer, clock, deltaTime, totalTime;</span>

    <span class="s0">var patternIdOffset = </span><span class="s3">10000000000</span>

    <span class="s4">// Змінні необхідні для роботи AR оточення</span>
    <span class="s0">var arToolkitSource, arToolkitContext;</span>

    <span class="s4">// Головний контейнер, до якого увійдуть всі 3D об'єкти для програми</span>
    <span class="s0">var markerRoot, mainContainer;</span>

    <span class="s4">// Окремий масив для зберігання всього аудіо та відео контенту, який буде</span>
    <span class="s4">// запущений натисканням на екран смартфона</span>
    <span class="s0">var audioContent = [];</span>

    <span class="s0">var contentPromises = [];</span>

    <span class="s0">let contentInitialized = </span><span class="s2">false</span><span class="s0">;</span>
    <span class="s0">let barcodesSound = </span><span class="s2">new </span><span class="s0">Map();</span>
    <span class="s0">let patternsSound = </span><span class="s2">new </span><span class="s0">Map();</span>
    <span class="s0">let barcodesID = [];</span>
    <span class="s0">let patternsID = [];</span>

    <span class="s0">let controller;</span>

    <span class="s4">// Ініціалізуємо сцену та запускаємо цикл анімації</span>
    <span class="s0">initialize();</span>
    <span class="s0">animate();</span>

    <span class="s0">function initialize() {</span>
        <span class="s4">// Оголошуємо сцену, в яку додамо головний контейнер з усіма 3D об'єктами.</span>
        <span class="s0">scene = </span><span class="s2">new </span><span class="s0">THREE.Scene();</span>

        <span class="s4">// Додаємо світло на сцену, інакше базові матеріали будуть просто чорними.</span>
        <span class="s4">// т.к. їм нема чого відображати, зверніться до документації бібліотеки three.js, щоб</span>
        <span class="s4">// прочитати про докладну роботу класу Material</span>
        <span class="s0">let ambientLight = </span><span class="s2">new </span><span class="s0">THREE.AmbientLight(</span><span class="s3">0xffffff</span><span class="s0">, </span><span class="s3">0.75</span><span class="s0">);</span>
        <span class="s0">scene.add(ambientLight);</span>

        <span class="s4">// Додаємо камеру, яка буде пізніше перепризначена на камеру смартфона</span>
        <span class="s0">camera = </span><span class="s2">new </span><span class="s0">THREE.Camera();</span>
        <span class="s0">scene.add(camera);</span>
        <span class="s2">const </span><span class="s0">listener = </span><span class="s2">new </span><span class="s0">THREE.AudioListener();</span>
        <span class="s0">camera.add(listener);</span>
        <span class="s2">const </span><span class="s0">audioLoader = </span><span class="s2">new </span><span class="s0">THREE.AudioLoader();</span>

        <span class="s4">// Оголошуємо стандартний рендерер і додаємо його до тега body html документа</span>
        <span class="s0">renderer = </span><span class="s2">new </span><span class="s0">THREE.WebGLRenderer({</span>
                                                   <span class="s0">antialias: </span><span class="s2">true</span><span class="s0">,</span>
                                                   <span class="s0">alpha: </span><span class="s2">true</span>
                                           <span class="s0">});</span>
        <span class="s0">renderer.setClearColor(</span><span class="s2">new </span><span class="s0">THREE.Color(</span><span class="s1">'lightgrey'</span><span class="s0">), </span><span class="s3">0</span><span class="s0">)</span>
        <span class="s0">renderer.setSize(</span><span class="s3">640</span><span class="s0">, </span><span class="s3">480</span><span class="s0">);</span>
        <span class="s0">renderer.domElement.style.position = </span><span class="s1">'absolute'</span>
        <span class="s0">renderer.domElement.style.top = </span><span class="s1">'0px'</span>
        <span class="s0">renderer.domElement.style.left = </span><span class="s1">'0px'</span>
        <span class="s0">document.body.appendChild(renderer.domElement);</span>

        <span class="s0">clock = </span><span class="s2">new </span><span class="s0">THREE.Clock();</span>
        <span class="s0">deltaTime = </span><span class="s3">0</span><span class="s0">;</span>
        <span class="s0">totalTime = </span><span class="s3">0</span><span class="s0">;</span>

        <span class="s0">arToolkitSource = </span><span class="s2">new </span><span class="s0">THREEx.ArToolkitSource({</span>
                                                             <span class="s0">sourceType: </span><span class="s1">'webcam'</span><span class="s0">,</span>
                                                     <span class="s0">});</span>

        <span class="s4">// Функція перерендерує AR сцену під поточний розмір canvas</span>
        <span class="s0">function onResize() {</span>
            <span class="s0">arToolkitSource.onResize()</span>
            <span class="s0">arToolkitSource.copySizeTo(renderer.domElement)</span>
            <span class="s2">if </span><span class="s0">(arToolkitContext.arController !== null) {</span>
                <span class="s0">arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)</span>
            <span class="s0">}</span>
        <span class="s0">}</span>

        <span class="s4">// Викликаємо функцію під час ініціалізації AR</span>
        <span class="s0">arToolkitSource.init(function onReady() {</span>
            <span class="s0">onResize()</span>
        <span class="s0">});</span>

        <span class="s4">// Викликаємо функцію на resize івент веб-сторінки</span>
        <span class="s0">window.addEventListener(</span><span class="s1">'resize'</span><span class="s0">, function () {</span>
            <span class="s0">onResize()</span>
        <span class="s0">});</span>

        <span class="s4">// Ініціалізуємо AR контекст під камеру, патерни, баркод 3х3</span>
        <span class="s0">arToolkitContext = </span><span class="s2">new </span><span class="s0">THREEx.ArToolkitContext({</span>
                                                               <span class="s0">cameraParametersUrl: </span><span class="s1">'data/camera_para.dat'</span><span class="s0">,</span>
                                                               <span class="s0">detectionMode: </span><span class="s1">'mono_and_matrix'</span><span class="s0">,</span>
                                                               <span class="s0">matrixCodeType: </span><span class="s1">&quot;3x3&quot;</span><span class="s0">,</span>
                                                               <span class="s0">maxDetectionRate: </span><span class="s3">60</span><span class="s0">,</span>
                                                               <span class="s0">canvasWidth: </span><span class="s3">640</span><span class="s0">,</span>
                                                               <span class="s0">canvasHeight: </span><span class="s3">480</span>
                                                       <span class="s0">});</span>

        <span class="s4">// Відновлюємо матрицю проекції камери після закінчення ініціалізації</span>
        <span class="s0">arToolkitContext.init(function onCompleted() {</span>
            <span class="s0">camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());</span>
        <span class="s0">});</span>

        <span class="s4">// Створюємо головну групу для всіх 3D об'єктів</span>
        <span class="s0">mainContainer = </span><span class="s2">new </span><span class="s0">THREE.Group();</span>

        <span class="s4">// Масив назв файлів .patt. Масив заповнюється в порядку додавання маркерів</span>
        <span class="s4">// якщо замість .patt було додано баркод, на його місце в масив додається порожній рядок</span>
        <span class="s2">const </span><span class="s0">patternNames = [</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив баркодів, заповнюється одночасно з масивом патернів</span>
        <span class="s4">// якщо замість баркоду був доданий .patt, на його місце масив додається -1</span>
        <span class="s2">const </span><span class="s0">patternBarcode = [</span><span class="s3">1 </span><span class="s0">,</span><span class="s3">2 </span><span class="s0">,</span><span class="s3">3</span><span class="s0">];</span>
        <span class="s4">// Масив типів контенту кожного маркера, заповнюється значеннями: зображення, модель, відео</span>
        <span class="s2">const </span><span class="s0">modes = [</span><span class="s1">&quot;image&quot; </span><span class="s0">,</span><span class="s1">&quot;image&quot; </span><span class="s0">,</span><span class="s1">&quot;image&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив файлів моделей, якщо немає моделі буде додано порожній рядок</span>
        <span class="s2">const </span><span class="s0">modelFiles = [</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив файлів зображень, якщо немає зображення буде додано також порожній рядок</span>
        <span class="s2">const </span><span class="s0">imageFiles = [</span><span class="s1">&quot;lrrrr1.1.jpg&quot; </span><span class="s0">,</span><span class="s1">&quot;2.3.jpg&quot; </span><span class="s0">,</span><span class="s1">&quot;2.7.jpg&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив файлів відео, якщо немає відео буде ще один порожній рядок</span>
        <span class="s2">const </span><span class="s0">videoFiles = [</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot; </span><span class="s0">,</span><span class="s1">&quot;&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив файлів аудіо, якщо немає аудіо буде так само порожній рядок</span>
        <span class="s2">const </span><span class="s0">audioFiles = [</span><span class="s1">&quot;1.2лр.m4a&quot; </span><span class="s0">,</span><span class="s1">&quot;2.4.m4a&quot; </span><span class="s0">,</span><span class="s1">&quot;2.m4a&quot;</span><span class="s0">];</span>
        <span class="s4">// Масив опцій повтору аудіо та відео контенту, по дефолту для всіх буде false</span>
        <span class="s2">const </span><span class="s0">repeatOptions = [</span><span class="s1">&quot;false&quot; </span><span class="s0">,</span><span class="s1">&quot;false&quot; </span><span class="s0">,</span><span class="s1">&quot;false&quot;</span><span class="s0">];</span>

        <span class="s4">// Створюємо масив для всіх маркерів</span>
        <span class="s2">const </span><span class="s0">markerRoots = [];</span>
        <span class="s2">for </span><span class="s0">(let i = </span><span class="s3">0</span><span class="s0">; i &lt; </span><span class="s3">3</span><span class="s0">; i++) {</span>
            <span class="s0">markerRoots[i] = </span><span class="s2">new </span><span class="s0">THREE.Group();</span>
        <span class="s0">}</span>

        <span class="s4">// Проходимо по кожному маркеру з масиву і додаємо його в головний контейнер</span>
        <span class="s2">for </span><span class="s0">(let i = </span><span class="s3">0</span><span class="s0">; i &lt; </span><span class="s3">3</span><span class="s0">; i++) {</span>
            <span class="s0">mainContainer.add(markerRoots[i]);</span>

            <span class="s4">// Якщо поточний маркер – це баркод, створюємо AR контролер під баркод</span>
            <span class="s4">// якщо поточний маркер це патерн, аналогічно створюємо AR контролер під патерн</span>
            <span class="s2">if </span><span class="s0">(patternBarcode[i] === -</span><span class="s3">1</span><span class="s0">) {</span>
                <span class="s0">let markerControls1 = </span><span class="s2">new </span><span class="s0">THREEx.ArMarkerControls(arToolkitContext, markerRoots[i], {</span>
                        <span class="s0">type: </span><span class="s1">'pattern'</span><span class="s0">, patternUrl: patternNames[i], size: </span><span class="s3">1 </span><span class="s0">+ (i + </span><span class="s3">1</span><span class="s0">) / patternIdOffset</span>
                <span class="s0">})</span>
                <span class="s0">patternsID.push(patternNames[i]);</span>
            <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                <span class="s0">let markerControls1 = </span><span class="s2">new </span><span class="s0">THREEx.ArMarkerControls(arToolkitContext, markerRoots[i], {</span>
                        <span class="s0">type: </span><span class="s1">&quot;barcode&quot;</span><span class="s0">, barcodeValue: patternBarcode[i],</span>
                <span class="s0">})</span>
                <span class="s0">barcodesID.push(patternBarcode[i]);</span>
            <span class="s0">}</span>

            <span class="s4">// Використовуємо switch для роботи з кожним окремим випадком контенту</span>
            <span class="s2">switch </span><span class="s0">(modes[i]) {</span>
                <span class="s4">// Якщо контент під маркер це модель</span>
                <span class="s2">case </span><span class="s1">'model'</span><span class="s0">:</span>
                    <span class="s0">function onProgress(xhr) { console.log((xhr.loaded / xhr.total * </span><span class="s3">100</span><span class="s0">) + </span><span class="s1">'% loaded'</span><span class="s0">); }</span>
                    <span class="s0">function onError(xhr) { console.log(</span><span class="s1">'An error happened'</span><span class="s0">); }</span>

                    <span class="s0">contentPromises.push(</span><span class="s2">new </span><span class="s0">Promise((resolve) =&gt; {</span>
                            <span class="s2">const </span><span class="s0">test = </span><span class="s2">new </span><span class="s0">THREE.GLTF2Loader().load(</span><span class="s5">`</span><span class="s0">${modelFiles[i]}</span><span class="s5">`</span><span class="s0">, (response) =&gt; {</span>
                                <span class="s2">const </span><span class="s0">scene = response.scene;</span>
                                <span class="s2">const </span><span class="s0">object = scene.children[</span><span class="s3">0</span><span class="s0">];</span>
                                <span class="s4">// Іноді модель не можна побачити з кількох причин, найчастіше варто збільшити чи зменшити у 100 разів.</span>
                                <span class="s4">// Читайте: https://threejs.org/docs/index.html#manual/en/introduction/Loading-3D-models</span>
                                <span class="s4">// Тут ми зменшуємо її, щоб точно побачити її на сцені. Ви можете видалити цю шкалу, якщо потрібно</span>
                                <span class="s0">object.scale.set(</span><span class="s3">0.01</span><span class="s0">, </span><span class="s3">0.01</span><span class="s0">, </span><span class="s3">0.01</span><span class="s0">);</span>
                                <span class="s4">// Ви можете самостійно змінити поворот або позицію моделі</span>
                                <span class="s4">// object.position.set(0, Math.PI / 2, Math.PI / 4);</span>
                                <span class="s4">// object.rotation.set(0, Math.PI / 2, Math.PI / 4);</span>
                                <span class="s4">// Додавання нашої моделі до контейнера групи маркерів</span>
                                <span class="s0">markerRoots[i].add(object);</span>
                                <span class="s0">resolve(modelFiles[i])</span>
                            <span class="s0">}, onProgress, onError)</span>
                    <span class="s0">}).then((file) =&gt; {</span>
                            <span class="s0">console.log(</span><span class="s5">`</span><span class="s0">File ${file} loaded</span><span class="s5">`</span><span class="s0">)</span>
                    <span class="s0">}))</span>
                    <span class="s2">break</span><span class="s0">;</span>
                    <span class="s4">// Якщо контент під маркер це зображення</span>
                <span class="s2">case </span><span class="s1">'image'</span><span class="s0">:</span>
                    <span class="s2">if </span><span class="s0">(imageFiles[i]) {</span>
                        <span class="s0">contentPromises.push(</span><span class="s2">new </span><span class="s0">Promise((resolve) =&gt; {</span>
                                <span class="s4">// Завантажуємо зображення</span>
                                <span class="s0">let loader = </span><span class="s2">new </span><span class="s0">THREE.TextureLoader();</span>
                                <span class="s0">loader.load(</span><span class="s5">`</span><span class="s0">${imageFiles[i]}</span><span class="s5">`</span><span class="s0">, (texture) =&gt; {</span>
                                    <span class="s0">let geometry1, ratio = texture.image.naturalWidth / texture.image.naturalHeight;</span>
                                    <span class="s2">if </span><span class="s0">(texture.image.naturalHeight &lt; texture.image.naturalWidth) {</span>
                                        <span class="s0">geometry1 = </span><span class="s2">new </span><span class="s0">THREE.PlaneBufferGeometry(ratio, </span><span class="s3">1</span><span class="s0">);</span>
                                    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                                        <span class="s0">geometry1 = </span><span class="s2">new </span><span class="s0">THREE.PlaneBufferGeometry(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1 </span><span class="s0">/ ratio);</span>
                                    <span class="s0">}</span>
                                    <span class="s0">let material1 = </span><span class="s2">new </span><span class="s0">THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });</span>
                                    <span class="s0">mesh1 = </span><span class="s2">new </span><span class="s0">THREE.Mesh(geometry1, material1);</span>
                                    <span class="s4">// Повертаємо площину</span>
                                    <span class="s0">mesh1.rotation.x = -Math.PI / </span><span class="s3">2</span><span class="s0">;</span>
                                    <span class="s4">// Додаємо площину у контейнер</span>
                                    <span class="s0">markerRoots[i].add(mesh1);</span>
                                    <span class="s0">resolve(imageFiles[i])</span>
                                <span class="s0">});</span>
                        <span class="s0">}).then(image =&gt; {</span>
                                <span class="s0">console.log(</span><span class="s5">`</span><span class="s0">File ${image} loaded</span><span class="s5">`</span><span class="s0">)</span>
                        <span class="s0">}))</span>
                    <span class="s0">}</span>
                    <span class="s2">break</span><span class="s0">;</span>
                    <span class="s4">// Якщо контент під маркер - це відео</span>
                <span class="s2">case </span><span class="s1">'video'</span><span class="s0">:</span>
                    <span class="s4">// Оголошуємо площину під відео</span>
                    <span class="s0">let geometry2 = </span><span class="s2">new </span><span class="s0">THREE.PlaneBufferGeometry(</span><span class="s3">1.6 </span><span class="s0">, </span><span class="s3">0.9</span><span class="s0">);</span>
                    <span class="s4">// Оголошуємо та завантажуємо відео</span>
                    <span class="s0">let video = document.createElement(</span><span class="s1">'video'</span><span class="s0">);</span>
                    <span class="s0">video.src = </span><span class="s5">`</span><span class="s0">${videoFiles[i]}</span><span class="s5">`</span><span class="s0">;</span>
                    <span class="s0">video.playsInline = </span><span class="s2">true</span><span class="s0">;</span>
                    <span class="s4">// Встановлюємо відео на автоповтор залежно від значення у масиві</span>
                    <span class="s2">if </span><span class="s0">(repeatOptions[i]) {</span>
                        <span class="s0">video.addEventListener(</span><span class="s1">'ended'</span><span class="s0">, () =&gt; {</span>
                                <span class="s0">video.play();</span>
                        <span class="s0">})</span>
                    <span class="s0">}</span>
                    <span class="s4">// Додаємо відео до масиву аудіо контенту</span>
                    <span class="s2">if </span><span class="s0">(patternBarcode[i] === -</span><span class="s3">1</span><span class="s0">) {</span>
                        <span class="s0">patternsSound.set(i, video);</span>
                    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                        <span class="s0">barcodesSound.set(patternBarcode[i], video);</span>
                    <span class="s0">}</span>
                    <span class="s4">// Перенаправляємо текстуру з відео на матеріал для площини.</span>
                    <span class="s0">let texture2 = </span><span class="s2">new </span><span class="s0">THREE.VideoTexture(video);</span>
                    <span class="s0">texture2.minFilter = THREE.LinearFilter;</span>
                    <span class="s0">texture2.magFilter = THREE.LinearFilter;</span>
                    <span class="s0">texture2.format = THREE.RGBFormat;</span>
                    <span class="s0">let material2 = </span><span class="s2">new </span><span class="s0">THREE.MeshBasicMaterial({ map: texture2 });</span>
                    <span class="s0">mesh2 = </span><span class="s2">new </span><span class="s0">THREE.Mesh(geometry2, material2);</span>
                    <span class="s4">// Повертаємо площину</span>
                    <span class="s0">mesh2.rotation.x = -Math.PI / </span><span class="s3">2</span><span class="s0">;</span>
                    <span class="s4">// Додаємо площину у контейнер</span>
                    <span class="s0">markerRoots[i].add(mesh2);</span>
                    <span class="s2">break</span><span class="s0">;</span>
                <span class="s2">case </span><span class="s1">'controller'</span><span class="s0">:</span>
                    <span class="s0">controller = </span><span class="s2">new </span><span class="s0">THREE.Mesh(</span>
                    <span class="s2">new </span><span class="s0">THREE.CubeGeometry(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0.15</span><span class="s0">, </span><span class="s3">0.15</span><span class="s0">),</span>
                    <span class="s2">new </span><span class="s0">THREE.MeshBasicMaterial({ color: </span><span class="s1">'green' </span><span class="s0">})</span>
                    <span class="s0">);</span>
                    <span class="s0">controller.rotation.y = Math.PI / </span><span class="s3">2</span><span class="s0">;</span>
                    <span class="s0">controller.position.y = </span><span class="s3">0.125</span><span class="s0">;</span>
                    <span class="s0">controller.position.z = -</span><span class="s3">4.5</span><span class="s0">;</span>
                    <span class="s0">markerRoots[i].add(controller);</span>
                    <span class="s2">break</span><span class="s0">;</span>
                <span class="s2">default</span><span class="s0">:</span>
                    <span class="s4">// Якщо жодного контенту не додано, додаємо білу площину.</span>
                    <span class="s0">mesh11 = </span><span class="s2">new </span><span class="s0">THREE.Mesh(</span><span class="s2">new </span><span class="s0">THREE.PlaneBufferGeometry(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">),</span>
                    <span class="s2">new </span><span class="s0">THREE.MeshBasicMaterial({ color: </span><span class="s1">'#fff' </span><span class="s0">}));</span>
                    <span class="s4">// Повертаємо площину</span>
                    <span class="s0">mesh11.rotation.x = -Math.PI / </span><span class="s3">2</span><span class="s0">;</span>
                    <span class="s4">// Додаємо площину у контейнер</span>
                    <span class="s0">markerRoots[i].add(mesh11);</span>
                    <span class="s2">break</span><span class="s0">;</span>
            <span class="s0">}</span>

            <span class="s4">// Якщо є аудіо файли, налаштовуємо їх і додаємо в масив аудіо контенту.</span>
            <span class="s2">if </span><span class="s0">(audioFiles[i]) {</span>
                <span class="s0">contentPromises.push(</span><span class="s2">new </span><span class="s0">Promise((resolve, reject) =&gt; {</span>
                        <span class="s0">audioLoader.load(</span><span class="s5">`</span><span class="s0">${audioFiles[i]}</span><span class="s5">`</span><span class="s0">, function (buffer) {</span>
                            <span class="s4">// Створюємо аудіо джерело</span>
                            <span class="s0">let sound = </span><span class="s2">new </span><span class="s0">THREE.Audio(listener);</span>
                            <span class="s0">sound.name = </span><span class="s5">`</span><span class="s0">${audioFiles[i]}</span><span class="s5">`</span><span class="s0">;</span>
                            <span class="s0">sound.setBuffer(buffer);</span>
                            <span class="s4">// Встановлюємо відео на автоповтор залежно від значення у масиві</span>
                            <span class="s2">if </span><span class="s0">(repeatOptions[i]) {</span>
                                <span class="s0">sound.setLoop(</span><span class="s2">true</span><span class="s0">);</span>
                            <span class="s0">}</span>
                            <span class="s2">if </span><span class="s0">(patternBarcode[i] === -</span><span class="s3">1</span><span class="s0">) {</span>
                                <span class="s0">patternsSound.set(i, sound);</span>
                            <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                                <span class="s0">barcodesSound.set(patternBarcode[i], sound);</span>
                            <span class="s0">}</span>
                            <span class="s0">resolve(sound)</span>
                        <span class="s0">});</span>
                <span class="s0">}).then((sound) =&gt; {</span>
                        <span class="s0">sound.play()</span>
                        <span class="s0">sound.stop()</span>
                        <span class="s0">console.log(</span><span class="s5">`</span><span class="s0">File ${sound.name} loaded</span><span class="s5">`</span><span class="s0">)</span>
                <span class="s0">}))</span>
            <span class="s0">}</span>
        <span class="s0">}</span>

        <span class="s4">// Ховаємо лоадер після завантаження компонентів</span>
        <span class="s0">Promise.all(contentPromises)</span>
                <span class="s0">.then(() =&gt; {</span>
                <span class="s0">console.log(</span><span class="s1">'Most of the content loaded'</span><span class="s0">)</span>
                <span class="s0">contentInitialized = </span><span class="s2">true</span><span class="s0">;</span>
                <span class="s0">loader.style.opacity = </span><span class="s1">'0'</span><span class="s0">;</span>
        <span class="s0">});</span>

        <span class="s4">// Додаємо головний контейнер на сцену</span>
        <span class="s0">scene.add(mainContainer);</span>
    <span class="s0">}</span>

    <span class="s0">function checkController() {</span>
        <span class="s2">if </span><span class="s0">(controller) {</span>
            <span class="s0">mainContainer.traverse((object) =&gt; {</span>
                    <span class="s2">if </span><span class="s0">(object.isMesh &amp;&amp; object !== controller) {</span>
                        <span class="s2">if </span><span class="s0">(detectCollisionCubes(object, controller)) {</span>
                            <span class="s0">object.material.color.set(</span><span class="s1">'red'</span><span class="s0">)</span>
                        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                            <span class="s0">object.material.color.set(</span><span class="s1">'white'</span><span class="s0">)</span>
                        <span class="s0">}</span>
                    <span class="s0">}</span>
            <span class="s0">});</span>
        <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s4">// Функція пошуку перетинів між двома об'єктами сцени</span>
    <span class="s0">function detectCollisionCubes(object1, object2) {</span>
        <span class="s0">object1.geometry.computeBoundingBox();</span>
        <span class="s0">object2.geometry.computeBoundingBox();</span>
        <span class="s0">object1.updateMatrixWorld();</span>
        <span class="s0">object2.updateMatrixWorld();</span>

        <span class="s2">const </span><span class="s0">box1 = object1.geometry.boundingBox.clone();</span>
        <span class="s0">box1.applyMatrix4(object1.matrixWorld);</span>

        <span class="s2">const </span><span class="s0">box2 = object2.geometry.boundingBox.clone();</span>
        <span class="s0">box2.applyMatrix4(object2.matrixWorld);</span>

        <span class="s2">return </span><span class="s0">box1.intersectsBox(box2);</span>
    <span class="s0">};</span>

    <span class="s4">// Оновлюємо AR контент на кожен кадр</span>
    <span class="s0">function update() {</span>
        <span class="s2">if </span><span class="s0">(arToolkitSource.ready !== </span><span class="s2">false</span><span class="s0">) {</span>
            <span class="s0">arToolkitContext.update(arToolkitSource.domElement);</span>
            <span class="s2">if </span><span class="s0">(contentInitialized) {</span>
                <span class="s2">if </span><span class="s0">(barcodesID.length) {</span>
                    <span class="s0">barcodesID.forEach((elem, index) =&gt; {</span>
                            <span class="s2">if </span><span class="s0">(arToolkitContext.arController.barcodeMarkers[elem].inCurrent) {</span>
                                <span class="s0">let sound = barcodesSound.get(elem);</span>
                                <span class="s2">if </span><span class="s0">(sound &amp;&amp; !sound.isPlaying) sound.play();</span>
                            <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                                <span class="s0">let sound = barcodesSound.get(elem);</span>
                                <span class="s2">if </span><span class="s0">(sound &amp;&amp; sound.nodeName === </span><span class="s1">'VIDEO'</span><span class="s0">) {</span>
                                    <span class="s2">if </span><span class="s0">(!sound.paused) sound.pause()</span>
                                <span class="s0">}</span>
                                <span class="s2">if </span><span class="s0">(sound &amp;&amp; sound.isPlaying) sound.stop();</span>
                            <span class="s0">}</span>
                    <span class="s0">})</span>
                <span class="s0">}</span>
                <span class="s2">if </span><span class="s0">(patternsID.length) {</span>
                    <span class="s2">for </span><span class="s0">(let index = </span><span class="s3">0</span><span class="s0">; index &lt; patternsID.length; index++) {</span>
                        <span class="s2">if </span><span class="s0">(arToolkitContext.arController.patternMarkers[index].inCurrent) {</span>
                            <span class="s0">let patternID = (arToolkitContext.arController.patternMarkers[index].markerWidth - </span><span class="s3">1</span><span class="s0">) * patternIdOffset - </span><span class="s3">1</span><span class="s0">;</span>
                            <span class="s0">patternID = Math.round(patternID)</span>
                            <span class="s0">let sound = patternsSound.get(patternID);</span>
                            <span class="s2">if </span><span class="s0">(sound &amp;&amp; !sound.isPlaying) sound.play();</span>
                        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
                            <span class="s0">let patternID = (arToolkitContext.arController.patternMarkers[index].markerWidth - </span><span class="s3">1</span><span class="s0">) * patternIdOffset - </span><span class="s3">1</span><span class="s0">;</span>
                            <span class="s0">patternID = Math.round(patternID)</span>
                            <span class="s0">let sound = patternsSound.get(patternID);</span>
                            <span class="s2">if </span><span class="s0">(sound &amp;&amp; sound.nodeName === </span><span class="s1">'VIDEO'</span><span class="s0">) {</span>
                                <span class="s2">if </span><span class="s0">(!sound.paused) sound.pause()</span>
                            <span class="s0">}</span>
                            <span class="s2">if </span><span class="s0">(sound &amp;&amp; sound.isPlaying) sound.stop();</span>
                        <span class="s0">}</span>
                    <span class="s0">}</span>
                <span class="s0">}</span>
            <span class="s0">}</span>
        <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s4">// Рендерім сцену на кожен кадр</span>
    <span class="s0">function render() {</span>
        <span class="s0">renderer.render(scene, camera);</span>
    <span class="s0">}</span>

    <span class="s4">// Запускаємо цикл анімації</span>
    <span class="s0">function animate(time) {</span>
        <span class="s4">// Прив'язуємо цикл анімації до рендеру браузера</span>
        <span class="s0">requestAnimationFrame(animate);</span>
        <span class="s0">deltaTime = clock.getDelta();</span>
        <span class="s0">totalTime += deltaTime;</span>
        <span class="s0">update();</span>
        <span class="s0">checkController();</span>
        <span class="s0">render();</span>
    <span class="s0">}</span>
<span class="s0">}</span>

<span class="s4">// Прибираємо блок після натискання на екран для дозволу аудіо програвання на iOS</span>
<span class="s0">access.addEventListener(</span><span class="s1">'click'</span><span class="s0">, () =&gt; {</span>
<span class="s0">initiateExperience();</span>
<span class="s0">document.body.removeChild(access);</span>
<span class="s0">loader.style.display = </span><span class="s1">'block'</span><span class="s0">;</span>
<span class="s0">});</span>
<span class="s0">&lt;/script&gt;</span>

<span class="s0">&lt;/body&gt;</span>

<span class="s0">&lt;/html&gt;</span></pre>
</body>
</html>